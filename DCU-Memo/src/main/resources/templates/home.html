<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Memo Share</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: '#FACC15', /* 노란색 */
                        background: '#111111',
                        card: '#1E1E1E',
                        text: '#F9FAFB',
                        muted: '#9CA3AF',
                        accent: '#FFD700'
                    },
                    fontFamily: {
                        display: ['Noto Sans KR', 'sans-serif'],
                    },
                    borderRadius: {
                        DEFAULT: '0.5rem',
                    },
                },
            },
        };
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        h1 { font-family: 'Isamanru', serif; }
        span, button, input, textarea { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-background text-text font-display">
<div class="flex flex-col h-screen">
    <!-- 헤더 -->
    <header class="relative flex items-center justify-center p-4 bg-card border-b border-gray-700">
        <h1 class="text-2xl font-bold text-primary flex items-center">
            <span class="material-symbols-outlined mr-2">edit</span> DCU Memo
        </h1>
        <div class="absolute right-4 flex items-center space-x-4" th:if="${session.member != null}">
            <a href="isPublic" class="text-text hover:text-primary">공유된 메모</a>
            <span th:text="|${session.member.name}|"></span>
            <button class="px-3 py-1 font-semibold text-black rounded-md bg-primary hover:bg-yellow-400"
                    onclick="location.href='/logout'">로그아웃</button>
        </div>
    </header>
    <main class="flex flex-1 p-6 gap-6 overflow-hidden">
        <div class="flex flex-col w-3/5 space-y-4">
            <!-- 메모 작성 -->
            <div class="flex-1 p-6 rounded-md bg-card border border-gray-700 flex flex-col shadow-md">
                <div class="flex items-center justify-between mb-2">
                    <input class="flex-grow p-2 text-lg font-bold bg-transparent border-0 rounded-md focus:ring-0 text-text"
                           id="memo-title" placeholder="제목" type="text"/>
                    <div class="flex items-center space-x-2 text-sm text-muted">
                        <span>비공개</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="1" class="sr-only peer" name="checkBox">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer-checked:bg-primary transition"></div>
                        </label>
                        <span>공개</span>
                    </div>
                </div>
                <hr class="border-gray-700 mb-3">
                <textarea class="flex-1 w-full p-3 bg-background text-text border-0 rounded-md resize-none focus:outline-none"
                          id="memo-content" placeholder="→ 메모를 작성해주세요 ←"></textarea>
            </div>
            <div class="flex justify-center mt-4">
                <button class="px-6 py-2 font-semibold text-white rounded-md bg-primary hover:bg-opacity-90" id="add-memo-btn">등록</button>
            </div>
        </div>
        <div class="w-2/5 flex flex-col space-y-4 overflow-y-auto">
            <h2 class="text-lg font-bold text-primary">저장된 내 메모</h2>
            <div id="memo-container-grid" class="space-y-3"></div>
        </div>
    </main>
</div>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const memoTitle = document.getElementById('memo-title');
        const memoContent = document.getElementById('memo-content');
        const addMemoBtn = document.getElementById('add-memo-btn');
        const memoContainerGrid = document.getElementById('memo-container-grid');
        const isPublicCheckbox = document.querySelector('input[name="checkBox"]');

        // 최신순으로 로그인 사용자의 모든 메모 불러오기
async function loadMemos() {
    try {
        const res = await fetch('/api/memos', { method: 'GET', credentials: 'include' });
        if (!res.ok) throw new Error("메모 로딩 실패");
        let memos = await res.json();

        // modDate 기준으로 내림차순 정렬
        memos.sort((a, b) => new Date(b.modDate) - new Date(a.modDate));

        memoContainerGrid.innerHTML = '';
        memos.forEach(m => {
            const item = document.createElement('div');
            item.className =
                'relative p-4 rounded-md bg-card border border-gray-700 shadow hover:bg-gray-800 transition cursor-pointer memo-item';
            item.dataset.memoId = m.id;

            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="font-semibold text-primary">${m.title || '(제목 없음)'}</span>
                    <button class="text-red-400 hover:text-red-600 delete-memo text-lg font-bold">✕</button>
                </div>
                <p class="text-sm text-gray-300 break-words">${m.content || ''}</p>
            `;
            memoContainerGrid.appendChild(item);
        });
    } catch (err) {
        console.error('메모 불러오기 오류:', err);
        memoContainerGrid.innerHTML =
            "<p class='text-red-400 text-sm'>메모를 불러오는 중 오류가 발생했습니다.</p>";
    }
}

        // 메모 등록
        const addMemo = async () => {
            const title = memoTitle.value.trim();
            const content = memoContent.value.trim();
            const isPublicValue = isPublicCheckbox.checked;

            if (!title || !content) {
                alert("제목과 내용을 입력해주세요.");
                return;
            }

            const memoData = { title, content, is_public: isPublicValue };
            try {
                const response = await fetch('/api/memos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(memoData),
                    credentials: 'include'
                });

                if (response.ok) {
                    await loadMemos(); // 등록 후 즉시 리스트 새로고침
                    memoTitle.value = '';
                    memoContent.value = '';
                    isPublicCheckbox.checked = false;
                } else {
                    alert("메모 저장에 실패했습니다.");
                }
            } catch (error) {
                console.error('Error:', error);
                alert('메모 저장 중 오류 발생');
            }
        };
        addMemoBtn.addEventListener('click', addMemo);

        // 메모 삭제
        memoContainerGrid.addEventListener('click', async function(e) {
            const deleteButton = e.target.closest('.delete-memo');
            if (deleteButton) {
                const memoItem = e.target.closest('.memo-item');
                const memoId = memoItem.dataset.memoId;
                if (confirm('정말로 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/api/memos/${memoId}`, {
                            method: 'DELETE',
                            credentials: 'include'
                        });
                        if (response.ok) {
                            memoItem.remove();
                        } else {
                            alert('메모 삭제에 실패했습니다.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            }
        });

        // 초기 로드 시 전체 메모 보여주기
        await loadMemos();
    });
</script>
</body>
</html>
